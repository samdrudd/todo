<html>
<head>
<title>To Do</title>
<link rel="stylesheet" href="style.css" type="text/css">

<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>

<script>
var data = JSON.parse(localStorage.getItem("todoData"));
data = data || {};

// -------------------------------------------------
// FUNCTION: createTask
// ACCEPTS: string title, string desc
// RETURNS: task object
// -------------------------------------------------
function createTask(title, desc)
{
  // Generate ID and return JSON object
  today = new Date();
	
  id = today.getTime();
   
  todaysDate = (today.getMonth() + 1) + "-" + today.getDate() + "-" + today.getFullYear();
  
  return {id: id, title: title, desc: desc, status: 0, created: todaysDate}
}

// -------------------------------------------------
// FUNCTION: addTask
// ACCEPTS: Object task (returned from createTask)
// Adds given task to data array and localStorage
// 
// -------------------------------------------------
function addTask(task)
{
  // Add task to localStorage
  data[task.id] = task;
    
  var test = JSON.stringify(data);
  
  localStorage.setItem("todoData", JSON.stringify(data));

  addTaskToList(task);
  $("#" + task.id).hide();
  $("#" + task.id).fadeIn(500);
}

// -------------------------------------------------
// FUNCTION: clearTasks
// Clears list as well as localStorage
// -------------------------------------------------
function clearTasks()
{
  // Prompt for confirmation
  if (confirm("Click OK to clear all tasks."))
  {
    // Clear list and localStorage
    localStorage.clear();
    data = {};
    $("#list_task_container").html("");
  }
}

// -------------------------------------------------
// FUNCTION: deleteTask
// ACCEPTS: id of task to delete
// Removes task with associated id from data
// Pushes updated data to localStorage
// -------------------------------------------------
function deleteTask(taskid)
{
    // Confirm and delete the task
    if (confirm("Click OK to delete task:\n\n" + data[taskid].title))
    {
      // Remove the task from the data array
      delete data[taskid];

      // Push data to localStorage
      localStorage.setItem("todoData", JSON.stringify(data));

      // Remove corresponding div from list
      $("#" + taskid).fadeOut(500);
	}
}

// -------------------------------------------------
// FUNCTION: doneTask
// ACCEPTS: id of task to mark done
// Collapses task's div and highlights it green to
// indicate the task has been completed
// @TODO: Store task status in localStorage so that 
// completed tasks show up as completed on page refresh
// -------------------------------------------------
function doneTask(taskid)
{
  var task = $("#" + taskid);

  if (!task.hasClass("completed"))
  {
    $("#" + taskid + " pre, #" + taskid + " h4").slideUp(500, function(){ task.addClass("completed"); });
	data[taskid].status = 1;
	
  }
  else
  {
    task.removeClass("completed");
    $("#" + taskid + " pre, #" + taskid + " h4").slideDown(500);
	data[taskid].status = 0;
  }
  
  // Push data to localStorage
  localStorage.setItem("todoData", JSON.stringify(data));
}

// -------------------------------------------------
// FUNCTION: addTaskToList
// ACCEPTS: task object to add to list
// Creates and displays HTML associated with task object 
// -------------------------------------------------
function addTaskToList(task)
{  
  // Create the delete button 
  var delButton = $("<input>", {
	type: "button",
	class: "delete action",
	value: String.fromCharCode(10008),
	onClick: "deleteTask(" + task.id + ");"});

  // Create done button
  var doneButton = $("<input>", {
	type: "button",
	class: "done action",
	value: String.fromCharCode(10004),
	onClick: "doneTask(" + task.id + ");"});

  // Create task div
  var taskDiv = $("<div>", {
    id: task.id,
	class: "task"});
  taskDiv.append(delButton);
  taskDiv.append(doneButton);
  
  taskDiv.append("<h3>" + task.title + "</h3><h4>Created: " + task.created + "</h4><pre>" + task.desc + "</pre>");

  $("#list_task_container").append(taskDiv);
  
  // If task is stored as completed
  if (task.status === 1)
  {
	taskDiv.addClass("completed");
	$("#" + taskid + " pre, #" + taskid + " h4").hide();
  }
}

// -------------------------------------------------
// FUNCTION: updateList
// ACCEPTS: 
// Clears both the HTML list and the list in localStorage
// -------------------------------------------------
function updateList()
{
  // Clear list
  $("#list_task_container").html("");

  // Repopulate with tasks from data
  for (taskid in data)
  {
    addTaskToList(data[taskid]);
  }
}

// DOCUMENT.READY
$( document ).ready(function() {
var data = {};

// Initalize list from localStorage
updateList();

// -----------------------------------------------
// FUNCTION: ADD TASK
// Adds a task to the list and to localStorage
// -----------------------------------------------
$( "#add-task" ).click(function() {
  // Get task info from form
  var title = $("#task-title").val();
  var desc = $("#task-desc").val();

  // If no title, don't add anything
  if (title === "") return;

  // Create task, add it to list and localStorage
  var tasktoadd = createTask(title, desc);
  addTask(tasktoadd);

  // Clear form
  $("#task-title").val("");
  $("#task-desc").val("");
}); // END FUNCTION: ADD TASK

// Keep add task form with you as you scroll
$(window).scroll(function() {
  $("#add_task_container").animate({"marginTop": ($(window).scrollTop() + 5) + "px"}, 0);
});

}); // END DOCUMENT.READY

</script>

</head>

<body>

<div id="add_task_container">
  <div>
    <input id="task-title" type="text" placeholder="Title" size="30" />
  </div>
  <div>
    <textarea id="task-desc" placeholder="Description" rows="5" cols="30"></textarea>
  </div>
  <div>
    <input id="add-task" type="submit" class="button" value="+New Task" />
  </div>
  <div>
    <input type="button" class="button" value="Clear Tasks" onClick="clearTasks()"></input>
  </div>
</div>

<div id="list_task_container">

</div>

</body>
</html>
